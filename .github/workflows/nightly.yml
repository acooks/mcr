name: Nightly Comprehensive Tests
permissions:
  contents: read

on:
  schedule:
    # Run at 2 AM UTC every night
    - cron: '0 2 * * *'
  workflow_dispatch:  # Allow manual trigger

env:
  CARGO_TERM_COLOR: always

jobs:
  topology-tests:
    name: Topology Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30
    strategy:
      matrix:
        include:
          - test: baseline_50k
            script: "tests/topologies/baseline_test.sh --rate 50000 --packets 50000"
          - test: chain_3hop
            script: "tests/topologies/chain_3hop.sh"
          - test: tree_fanout
            script: "tests/topologies/tree_fanout.sh"
          - test: high_fanout_50
            script: "tests/topologies/high_fanout_50.sh"
          - test: tree_converge
            script: "tests/topologies/tree_converge.sh"
          - test: multi_worker
            script: "tests/topologies/multi_worker.sh"
          - test: fault_tolerance
            script: "tests/topologies/fault_tolerance.sh"
          - test: edge_cases
            script: "tests/topologies/edge_cases.sh"
          - test: dynamic_rules
            script: "tests/topologies/dynamic_rules.sh"
      fail-fast: false  # Continue testing other topologies even if one fails

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install Rust toolchain
      uses: dtolnay/rust-toolchain@stable

    - name: Build release binaries
      run: |
        cargo build --release --bins

    - name: Run topology test - ${{ matrix.test }}
      run: |
        sudo -E bash ${{ matrix.script }}

    - name: Extract performance metrics
      if: always()
      run: |
        echo "=== Topology Test: ${{ matrix.test }} ===" > metrics-${{ matrix.test }}.txt
        echo "Timestamp: $(date -u)" >> metrics-${{ matrix.test }}.txt
        echo "Commit: ${{ github.sha }}" >> metrics-${{ matrix.test }}.txt
        echo "Branch: ${{ github.ref_name }}" >> metrics-${{ matrix.test }}.txt
        echo "" >> metrics-${{ matrix.test }}.txt

        # Extract key metrics from logs
        echo "=== Performance Metrics ===" >> metrics-${{ matrix.test }}.txt
        grep -E "pps|Gbps|packets sent|packets received|SUCCESS|FAILED" /tmp/*.log 2>/dev/null >> metrics-${{ matrix.test }}.txt || echo "No metrics found" >> metrics-${{ matrix.test }}.txt

        echo "" >> metrics-${{ matrix.test }}.txt
        echo "=== Test Outcome ===" >> metrics-${{ matrix.test }}.txt
        if grep -q "SUCCESS" /tmp/*.log 2>/dev/null; then
          echo "✅ Test passed" >> metrics-${{ matrix.test }}.txt
        else
          echo "❌ Test failed or incomplete" >> metrics-${{ matrix.test }}.txt
        fi

        cat metrics-${{ matrix.test }}.txt

    - name: Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: topology-metrics-${{ matrix.test }}
        path: |
          metrics-${{ matrix.test }}.txt
          /tmp/mcr_*.log
          /tmp/test_*.log

  baseline-analysis:
    name: Analyze Performance Baselines
    needs: topology-tests
    runs-on: ubuntu-latest
    if: always()

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Download all topology metrics
      uses: actions/download-artifact@v4
      with:
        path: all-metrics

    - name: Aggregate and analyze metrics
      run: |
        echo "=== Nightly Test Summary ===" > nightly-summary.txt
        echo "Date: $(date -u)" >> nightly-summary.txt
        echo "Commit: ${{ github.sha }}" >> nightly-summary.txt
        echo "" >> nightly-summary.txt

        # Aggregate all test results
        for dir in all-metrics/topology-metrics-*/; do
          if [ -d "$dir" ]; then
            echo "=== $(basename $dir) ===" >> nightly-summary.txt
            cat "$dir"/metrics-*.txt >> nightly-summary.txt
            echo "" >> nightly-summary.txt
          fi
        done

        cat nightly-summary.txt

    - name: Upload aggregated results
      uses: actions/upload-artifact@v4
      with:
        name: nightly-test-summary
        path: nightly-summary.txt

    - name: Check for failures
      run: |
        if grep -q "❌ Test failed" all-metrics/*/metrics-*.txt 2>/dev/null; then
          echo "::error::One or more topology tests failed"
          exit 1
        fi

  integration-stress:
    name: Integration Stress Tests
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install Rust toolchain
      uses: dtolnay/rust-toolchain@stable

    - name: Build integration test binaries
      run: |
        cargo build --release --bins
        cargo test --test integration --no-run --release

    - name: Run integration test suite (full run)
      run: |
        TEST_BINARY=$(find target/release/deps -name 'integration-*' -type f -executable ! -name '*.d' | head -1)
        if [ -z "$TEST_BINARY" ]; then
          echo "ERROR: Integration test binary not found"
          exit 1
        fi

        echo "Running full integration test suite..."
        sudo -E "$TEST_BINARY" --test-threads=1 2>&1 | tee integration-results.txt

    - name: Check integration test results
      if: always()
      run: |
        if grep -q "test result: ok" integration-results.txt; then
          echo "✅ All integration tests passed"
        else
          echo "::error::Integration tests failed"
          exit 1
        fi

    - name: Upload integration test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: integration-stress-results
        path: integration-results.txt

  sustained-performance:
    name: Sustained Performance Test (60s)
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install Rust toolchain
      uses: dtolnay/rust-toolchain@stable

    - name: Build release binaries
      run: |
        cargo build --release --bins

    - name: Run sustained 50k pps test (60 seconds)
      run: |
        # Run without profiling (perf not available in CI)
        # CI runners can only sustain ~50k pps reliably
        sudo bash tests/topologies/baseline_test.sh --rate 50000 --packets 3000000

    - name: Extract sustained performance metrics
      if: always()
      run: |
        echo "=== Sustained Performance Test (50k pps, 60s) ===" > sustained-metrics.txt
        echo "Timestamp: $(date -u)" >> sustained-metrics.txt
        echo "Commit: ${{ github.sha }}" >> sustained-metrics.txt
        echo "" >> sustained-metrics.txt
        grep -E "FINAL|matched|sent|buf_exhaust" /tmp/mcr*.log 2>/dev/null >> sustained-metrics.txt || echo "No metrics found"
        cat sustained-metrics.txt

    - name: Upload sustained performance results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: sustained-perf-results
        path: |
          sustained-metrics.txt
          /tmp/mcr*.log
